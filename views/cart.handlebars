<div class="box">
  <div class="cart-header">
    <a id="button-products" class="button" href="/products">‚Üê Seguir Comprando</a>
    <h1>Mi Carrito</h1>
  </div>

  {{#if products.length}}
    <div class="products-box">
      {{#each products}}
        <div class="product-card">
          <h3>{{this.product.title}}</h3>
          <hr>
          <p><strong>Categor√≠a:</strong> {{this.product.category}}</p>
          <p><strong>Precio unitario:</strong> ${{this.product.price}}</p>
          <p><strong>Stock disponible:</strong> {{this.product.stock}}</p>
          
          <div class="quantity-controls">
            <label><strong>Cantidad:</strong></label>
            <div class="quantity-buttons">
              <button class="button-quantity" onclick="decreaseQuantity('{{this.product._id}}', {{this.quantity}})">
                ‚ûñ
              </button>
              <span class="quantity-display">{{this.quantity}}</span>
              <button class="button-quantity" onclick="increaseQuantity('{{this.product._id}}', {{this.quantity}}, {{this.product.stock}})">
                ‚ûï
              </button>
            </div>
          </div>
          
          <p><strong>Subtotal:</strong> ${{multiply this.product.price this.quantity}}</p>
          <button class="button-delete" onclick="removeFromCart('{{this.product._id}}')">
            üóëÔ∏è Eliminar
          </button>
        </div>
      {{/each}}
    </div>

    <div class="cart-summary">
      <h2>Resumen de Compra</h2>
      <p class="total"><strong>Total:</strong> $<span id="cartTotal">0</span></p>
      <button id="purchase-button" class="button-purchase" onclick="purchaseCart()">
        Finalizar Compra
      </button>
      <button class="button-clear" onclick="clearCart()">
        Vaciar Carrito
      </button>
    </div>
  {{else}}
    <div class="empty-cart">
      <p>Tu carrito est√° vac√≠o</p>
      <a href="/products" class="button">Ver Productos</a>
    </div>
  {{/if}}
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2 id="modal-title"></h2>
    <div id="modal-body"></div>
    <button onclick="closeModal()">Cerrar</button>
  </div>
</div>

<style>
  .cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .products-box {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .product-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .product-card h3 {
    margin-bottom: 10px;
    color: #333;
  }

  .product-card p {
    margin: 8px 0;
    color: #666;
  }

  .quantity-controls {
    margin: 15px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
  }

  .quantity-controls label {
    display: block;
    margin-bottom: 8px;
    color: #333;
  }

  .quantity-buttons {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
  }

  .button-quantity {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .button-quantity:hover {
    background-color: #0056b3;
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
  }

  .button-quantity:active {
    transform: scale(0.95);
  }

  .button-quantity:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
    opacity: 0.5;
  }

  .quantity-display {
    font-size: 20px;
    font-weight: bold;
    color: #333;
    min-width: 30px;
    text-align: center;
  }

  .button-delete {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 10px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    width: 100%;
  }

  .button-delete:hover {
    background-color: #c82333;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
  }

  .button-delete:active {
    transform: translateY(0);
  }

  .cart-summary {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    margin-top: 20px;
  }

  .total {
    font-size: 24px;
    color: #28a745;
    margin: 20px 0;
  }

  .button-purchase {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 18px;
    cursor: pointer;
    margin: 10px;
    width: 80%;
  }

  .button-purchase:hover {
    background-color: #218838;
  }

  .button-clear {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    margin: 10px;
  }

  .button-clear:hover {
    background-color: #5a6268;
  }

  .empty-cart {
    text-align: center;
    padding: 60px 20px;
  }

  .empty-cart p {
    font-size: 20px;
    color: #666;
    margin-bottom: 20px;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
  }

  .modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
  }

  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover {
    color: #000;
  }

  #modal-body {
    margin: 20px 0;
  }

  .success-message {
    color: #28a745;
    background: #d4edda;
    padding: 15px;
    border-radius: 4px;
    margin: 10px 0;
  }

  .error-message {
    color: #721c24;
    background: #f8d7da;
    padding: 15px;
    border-radius: 4px;
    margin: 10px 0;
  }

  .ticket-info {
    background: #e7f3ff;
    padding: 15px;
    border-radius: 4px;
    margin: 10px 0;
  }

  .products-not-processed {
    background: #fff3cd;
    padding: 15px;
    border-radius: 4px;
    margin: 10px 0;
  }
</style>

<script>
  const cartId = '{{cartId}}';

  document.addEventListener('DOMContentLoaded', function() {
    calculateTotal();
  });

  function calculateTotal() {
    const products = {{{json products}}};
    let total = 0;
    
    products.forEach(item => {
      total += item.product.price * item.quantity;
    });
    
    document.getElementById('cartTotal').textContent = total.toFixed(2);
  }

  async function increaseQuantity(productId, currentQuantity, stock) {
    // Verificar si hay stock disponible
    if (currentQuantity >= stock) {
      showModal('Stock Insuficiente', '<p class="error-message">No hay m√°s unidades disponibles de este producto.</p>');
      return;
    }

    const newQuantity = currentQuantity + 1;
    await updateProductQuantity(productId, newQuantity);
  }

  async function decreaseQuantity(productId, currentQuantity) {
    if (currentQuantity <= 1) {
      // Si la cantidad es 1, preguntar si desea eliminar
      if (confirm('La cantidad es 1. ¬øDeseas eliminar el producto del carrito?')) {
        await removeFromCart(productId);
      }
      return;
    }

    const newQuantity = currentQuantity - 1;
    await updateProductQuantity(productId, newQuantity);
  }

  async function updateProductQuantity(productId, newQuantity) {
    try {
      const response = await fetch(`/api/carts/${cartId}/product/${productId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ quantity: newQuantity })
      });

      const data = await response.json();

      if (data.status === 'success') {
        // Recargar la p√°gina para mostrar los cambios
        location.reload();
      } else {
        showModal('Error', `<p class="error-message">${data.message}</p>`);
      }
    } catch (error) {
      console.error('Error:', error);
      showModal('Error', '<p class="error-message">Error al actualizar la cantidad.</p>');
    }
  }

  async function removeFromCart(productId) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar este producto del carrito?')) {
      return;
    }

    try {
      const response = await fetch(`/api/carts/${cartId}/product/${productId}`, {
        method: 'DELETE'
      });

      const data = await response.json();

      if (data.status === 'success') {
        // Mostrar mensaje de √©xito antes de recargar
        showModal('Producto Eliminado', '<p class="success-message">El producto ha sido eliminado del carrito exitosamente.</p>');
        
        // Recargar despu√©s de 1 segundo
        setTimeout(() => {
          location.reload();
        }, 1000);
      } else {
        showModal('Error', `<p class="error-message">Error al eliminar producto: ${data.message}</p>`);
      }
    } catch (error) {
      console.error('Error:', error);
      showModal('Error', '<p class="error-message">Error al eliminar producto. Por favor intenta nuevamente.</p>');
    }
  }

  async function clearCart() {
    if (!confirm('¬øEst√°s seguro de que quieres vaciar el carrito?')) {
      return;
    }

    try {
      const response = await fetch(`/api/carts/${cartId}`, {
        method: 'DELETE'
      });

      const data = await response.json();

      if (data.status === 'success') {
        location.reload();
      } else {
        alert('Error al vaciar carrito: ' + data.message);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al vaciar carrito');
    }
  }

  async function purchaseCart() {
    const button = document.getElementById('purchase-button');
    button.disabled = true;
    button.textContent = 'Procesando...';

    try {
      const response = await fetch(`/api/carts/${cartId}/purchase`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.status === 'success') {
        showModal('¬°Compra Exitosa! üéâ', createSuccessHTML(data));
        
        // Redirigir al ticket despu√©s de 2 segundos
        setTimeout(() => {
          window.location.href = `/ticket/${data.ticket.code}`;
        }, 2000);
      } else {
        showModal('Error en la Compra', createErrorHTML(data));
        button.disabled = false;
        button.textContent = 'Finalizar Compra';
      }
    } catch (error) {
      console.error('Error:', error);
      showModal('Error', '<p class="error-message">Error al procesar la compra</p>');
      button.disabled = false;
      button.textContent = 'Finalizar Compra';
    }
  }

  function createSuccessHTML(data) {
    let html = '<div class="success-message">';
    html += `<p><strong>C√≥digo de compra:</strong> ${data.ticket.code}</p>`;
    html += `<p><strong>Total:</strong> $${data.ticket.amount.toFixed(2)}</p>`;
    html += `<p><strong>Fecha:</strong> ${new Date(data.ticket.purchaseDate).toLocaleString()}</p>`;
    html += '</div>';

    if (data.ticket.products) {
      html += '<div class="ticket-info">';
      html += '<h3>Productos comprados:</h3><ul>';
      data.ticket.products.forEach(p => {
        html += `<li>${p.title} x${p.quantity} - $${p.subtotal.toFixed(2)}</li>`;
      });
      html += '</ul></div>';
    }

    if (data.productsNotProcessed && data.productsNotProcessed.length > 0) {
      html += '<div class="products-not-processed">';
      html += '<h3>‚ö†Ô∏è Productos sin stock suficiente:</h3><ul>';
      data.productsNotProcessed.forEach(p => {
        html += `<li>${p.title} - Solicitados: ${p.requestedQuantity}, Disponibles: ${p.availableStock}</li>`;
      });
      html += '</ul><p>Estos productos permanecen en tu carrito.</p></div>';
    }

    html += '<p>Se ha enviado un correo de confirmaci√≥n.</p>';
    
    return html;
  }

  function createErrorHTML(data) {
    let html = `<p class="error-message">${data.message}</p>`;
    
    if (data.productsNotProcessed) {
      html += '<div class="products-not-processed">';
      html += '<h3>Productos sin stock:</h3><ul>';
      data.productsNotProcessed.forEach(p => {
        html += `<li>${p.title} - Solicitados: ${p.requestedQuantity}, Disponibles: ${p.availableStock}</li>`;
      });
      html += '</ul></div>';
    }
    
    return html;
  }

  function showModal(title, bodyHTML) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-body').innerHTML = bodyHTML;
    document.getElementById('modal').style.display = 'block';
  }

  function closeModal() {
    document.getElementById('modal').style.display = 'none';
  }

  window.onclick = function(event) {
    const modal = document.getElementById('modal');
    if (event.target == modal) {
      closeModal();
    }
  }
</script>